<!DOCTYPE html>
<html>
<body>
<h3>Test Canvas</h3>
<div id="browseToolbar">
  <small>Search: </small><input type="text" name="searchQuery" onchange="br.searchRows(this.value);" onkeyup="this.onchange();" onpaste="this.onchange();" oninput="this.onchange();">
  <small>Filter: </small><input type="text" name="filterQuery">
  <small>Zoom: </small><input id="zoomRange" type="range" value="1.0" oninput="br.zoomExact(this.value);" min="0.01" max="10" step="0.01"/><button type="button" onclick="document.getElementById('zoomRange').value = 1.0; br.zoomExact(1.0)">Default</button>
  <!--<button type="button" onclick="br.zoomIn()">+</button><button type="button" onclick="br.zoomOut()">-</button><button type="button" onclick="br.zoomExact(1.0)">100%</button>-->
</div>
<div id="testCanv">
  <div id="canvToolTip">
    <h3 class="gene">Rv3198c</h3>
    <h3 class="name">(uvrD2)</h3>
    <p class="condition">
      <span class="condition">[3]: h37rv whib7 null ethanol vs. 1.0 ug/ml tetracyclin for 15 min</span>
    </p>
    <p>
      <span>Log fold change: -0.310</span>
    </p>
  </div>
</div>

<style>
    html, body { width: 100%; height: 100%; padding: 0; margin: 0; overflow: hidden; }
    #browseToolbar { width: 1000px; height: 50px; position: relative; }
    #testCanv { width: 100%; height: 800px; position: relative; }
    h3 { font-size: 16px; color: #666; }
    #canvToolTip { font: 12px Arial; position:absolute; display:none; top:0; left:0; border: 1px solid black; padding-left: 20px; padding-right: 20px; z-index: 2; background-color: rgba(255,255,255,0.9); }
    .gene { display: inline-block; }
    .name { padding-left: 10px; display: inline-block; }
    .condition { max-width: 300px; }
    #hmHighlightCanvas { z-index: 1; }
    #hmTextOverflowCover1, #hmTextOverflowCover2, #hmTextOverflowCover3 { z-index: 1; background-color: #FFF; }
</style>
<script>

function createCanvas(id, width, height, style) {
    var canv = document.createElement('canvas');
    canv.id = id;
    canv.width = width;
    canv.height = height;
    canv.style.cssText = style || '';
    return canv;
}

function getCoveragePerc(maxWidth, actWidth) {
    return maxWidth/actWidth;
}

function HMVertScrollBar(hmBr, width, height) {
    this.browser = hmBr;
    this.scrollY = 0;
    this.width = width;
    this.height = height;
    this.scrolling = false;
    this.startScrollY = 0;
    this.startScrollOff = 0;
    this.scrollerHeight = 0;
    this.scrollerFill = hmBr.settings.defaultScrollerFill;
    this.scrollerHighlightFill = hmBr.settings.highlightScrollerFill;
    this.scrollerDefaultFill = hmBr.settings.defaultScrollerFill;
}

HMVertScrollBar.prototype.init = function() {
    var hmVertScroll = this;
    this.scrollYCanv = createCanvas('hmScrollYCanvas', this.width, this.height, 'position: absolute; top: ' + this.browser.hmTL.top + 'px; left: ' + (this.browser.width - this.width) + 'px;');
    this.browser.parentDiv.appendChild(this.scrollYCanv);
    this.scrollYCtx = this.scrollYCanv.getContext("2d");
    this.scrollYCanv.onmousedown = function(e) {
        var evt = e || event;
        hmVertScroll.scrolling = true;
        hmVertScroll.startScrollY = hmVertScroll.scrollY;
        hmVertScroll.startScrollOff = evt.offsetY;
    };
    this.scrollYCanv.onmousemove = function(e) {
        var evt = e || event;
        if (hmVertScroll.onScroller(evt)) {
            if (hmVertScroll.scrollerFill !== hmVertScroll.scrollerHighlightFill) {
                hmVertScroll.scrollerFill = hmVertScroll.scrollerHighlightFill;
                hmVertScroll.redraw();
            }
        } else {
            if (hmVertScroll.scrollerFill !== hmVertScroll.scrollerDefaultFill) {
                hmVertScroll.scrollerFill = hmVertScroll.scrollerDefaultFill;
                hmVertScroll.redraw();
            }
        }
    };
    this.scrollYCanv.onmouseout = function(e) {
        if (hmVertScroll.scrollerFill !== hmVertScroll.scrollerDefaultFill) {
            hmVertScroll.scrollerFill = hmVertScroll.scrollerDefaultFill;
            hmVertScroll.redraw();
        }
    };
};

HMVertScrollBar.prototype.setWidth = function(width) {
    this.width = width;
    this.scrollYCanv.width = width;
    this.scrollYCanv.style.left = (this.browser.width - this.width) + 'px';
};

HMVertScrollBar.prototype.setHeight = function(height) {
    this.height = height;
    this.scrollYCanv.height = height;
};

HMVertScrollBar.prototype.setScrollY = function(scrollY) {
    this.scrollY = scrollY;
};

HMVertScrollBar.prototype.onScroller = function(evt) {
    return evt.offsetY > this.scrollY && evt.offsetY < this.scrollY + this.scrollerHeight;
};

HMVertScrollBar.prototype.onMouseMove = function(evt) {
    if (this.scrolling) {
        var diff = evt.offsetY - this.startScrollOff;
        this.scrollY = (this.startScrollY + diff < 0)? 0 : (this.startScrollY + diff > this.height - this.scrollerHeight)? this.height - this.scrollerHeight : this.startScrollY + diff;
        this.scrollerFill = this.scrollerHighlightFill;
        this.redraw();
        this.browser.onScrollY(this.scrollY);
    }
};

HMVertScrollBar.prototype.onMouseUp = function(evt) {
    this.scrolling = false;
    if (this.scrollerFill !== this.scrollerDefaultFill) {
        this.scrollerFill = this.scrollerDefaultFill;
        this.redraw();
    }
};

HMVertScrollBar.prototype.onWheel = function(evt) {
    if (!this.width || !this.height) return;
    var diff = evt.deltaY;
    this.scrollY = (this.scrollY + diff < 0)? 0 : (this.scrollY + diff > this.height - this.scrollerHeight)? this.height - this.scrollerHeight : this.scrollY + diff;
    this.redraw();
    this.browser.onScrollY(this.scrollY);
};

HMVertScrollBar.prototype.clear = function() {
    this.scrollYCtx.clearRect(0, 0, this.scrollYCanv.width, this.scrollYCanv.height);
};

HMVertScrollBar.prototype.redraw = function() {
    this.clear();
    this.render();
};

HMVertScrollBar.prototype.render = function() {
    var hmHeight = this.browser.getHeatmapHeight();
    var perc = getCoveragePerc(hmHeight, this.browser.numRows * this.browser.settings.cellHeight * this.browser.zoom);
    this.scrollerHeight = perc * this.height;
    this.scrollYCtx.fillStyle = this.scrollerFill;
    this.scrollYCtx.fillRect(0, this.scrollY, this.width, this.scrollerHeight);
    this.scrollYCtx.stroke();
};

function HMHorizScrollBar(hmBr, width, height) {
    this.browser = hmBr;
    this.scrollX = 0;
    this.width = width;
    this.height = height;
    this.scrolling = false;
    this.startScrollX = 0;
    this.startScrollOff = 0;
    this.scrollerWidth = 0;
    this.scrollerFill = hmBr.settings.defaultScrollerFill;
    this.scrollerHighlightFill = hmBr.settings.highlightScrollerFill;
    this.scrollerDefaultFill = hmBr.settings.defaultScrollerFill;
}

HMHorizScrollBar.prototype.init = function() {
    var hmHorizScroll = this;
    this.scrollXCanv = createCanvas('hmScrollXCanvas', this.width, this.height, 'position: absolute; top: ' + (this.browser.height - this.height) + 'px; left: ' + this.browser.hmTL.left + 'px');
    this.browser.parentDiv.appendChild(this.scrollXCanv);
    this.scrollXCtx = this.scrollXCanv.getContext("2d");
    this.scrollXCanv.onmousedown = function(e) {
        var evt = e || event;
        hmHorizScroll.scrolling = true;
        hmHorizScroll.startScrollX = hmHorizScroll.scrollX;
        hmHorizScroll.startScrollOff = evt.offsetX;
    };
    this.scrollXCanv.onmousemove = function(e) {
        var evt = e || event;
        if (hmHorizScroll.onScroller(evt)) {
            if (hmHorizScroll.scrollerFill !== hmHorizScroll.scrollerHighlightFill) {
                hmHorizScroll.scrollerFill = hmHorizScroll.scrollerHighlightFill;
                hmHorizScroll.redraw();
            }
        } else {
            if (hmHorizScroll.scrollerFill !== hmHorizScroll.scrollerDefaultFill) {
                hmHorizScroll.scrollerFill = hmHorizScroll.scrollerDefaultFill;
                hmHorizScroll.redraw();
            }
        }
    };
    this.scrollXCanv.onmouseout = function(e) {
        if (hmHorizScroll.scrollerFill !== hmHorizScroll.scrollerDefaultFill) {
            hmHorizScroll.scrollerFill = hmHorizScroll.scrollerDefaultFill;
            hmHorizScroll.redraw();
        }
    };
};

HMHorizScrollBar.prototype.setWidth = function(width) {
    this.width = width;
    this.scrollXCanv.width = width;
};

HMHorizScrollBar.prototype.setHeight = function(height) {
    this.height = height;
    this.scrollXCanv.height = height;
    this.scrollXCanv.style.top = (this.browser.height - this.height) + 'px';
};

HMHorizScrollBar.prototype.setScrollX = function(scrollX) {
    this.scrollX = scrollX;
};

HMHorizScrollBar.prototype.onScroller = function(evt) {
    return evt.offsetX > this.scrollX && evt.offsetX < this.scrollX + this.scrollerWidth;
};

HMHorizScrollBar.prototype.onMouseMove = function(evt) {
    if (this.scrolling) {
        var diff = evt.offsetX - this.startScrollOff;
        this.scrollX = (this.startScrollX + diff < 0)? 0 : (this.startScrollX + diff > this.width - this.scrollerWidth)? this.width - this.scrollerWidth : this.startScrollX + diff;
        this.scrollerFill = this.scrollerHighlightFill;
        this.redraw();
        this.browser.onScrollX(this.scrollX);
    }
};

HMHorizScrollBar.prototype.onMouseUp = function(evt) {
    this.scrolling = false;
    if (this.scrollerFill !== this.scrollerDefaultFill) {
        this.scrollerFill = this.scrollerDefaultFill;
        this.redraw();
    }
};

HMHorizScrollBar.prototype.onWheel = function(evt) {
    var diff = evt.deltaY;
    this.scrollX = (this.scrollX + diff < 0)? 0 : (this.scrollX + diff > this.width - this.scrollerWidth)? this.width - this.scrollerWidth : this.scrollX + diff;
    this.redraw();
    this.browser.onScrollX(this.scrollX);
};

HMHorizScrollBar.prototype.clear = function() {
    this.scrollXCtx.clearRect(0, 0, this.scrollXCanv.width, this.scrollXCanv.height);
};

HMHorizScrollBar.prototype.redraw = function() {
    this.clear();
    this.render();
};

HMHorizScrollBar.prototype.render = function() {
    var hmWidth = this.browser.getHeatmapWidth();
    var perc = getCoveragePerc(hmWidth, this.browser.numCols * this.browser.settings.cellWidth * this.browser.zoom);
    this.scrollerWidth = perc * this.width;
    this.scrollXCtx.fillStyle = this.scrollerFill;
    this.scrollXCtx.fillRect(this.scrollX, 0, this.scrollerWidth, this.height);
    this.scrollXCtx.stroke();
};

function HMHeatmap(hmBr, width, height, data, numRows, numCols, tlStart) {
    this.browser = hmBr;
    this.scrollX = 0;
    this.scrollY = 0;
    this.width = width;
    this.height = height;
    this.data = data;
    this.numRows = numRows;
    this.numCols = numCols;
    this.tlStart = tlStart;
    this.highlightedSearchIndices = [];
}

HMHeatmap.prototype.init = function() {
    var HMHeat = this;
    this.canv = createCanvas('hmCanvas', this.width, this.height, 'position: absolute; top: ' + this.tlStart.top + 'px; left: ' + this.tlStart.left + 'px');
    this.highlightCanv = createCanvas('hmHighlightCanvas', this.width, this.height, 'position: absolute; top: ' + this.tlStart.top + 'px; left: ' + this.tlStart.left + 'px');
    this.searchHighlightCanv = createCanvas('hmSearchHighlightCanvas', this.width, this.height, 'position: absolute; top: ' + this.tlStart.top + 'px; left: ' + this.tlStart.left + 'px');
    this.browser.parentDiv.appendChild(this.canv);
    this.browser.parentDiv.appendChild(this.highlightCanv);
    this.browser.parentDiv.appendChild(this.searchHighlightCanv);
    this.ctx = this.canv.getContext("2d");
    this.searchHighlightCtx = this.searchHighlightCanv.getContext("2d");
    this.searchHighlightCtx.strokeStyle = this.browser.settings.highlightSearchStroke;
    this.searchHighlightCtx.globalAlpha = this.browser.settings.highlightSearchStrokeOpacity;
    this.highlightCtx = this.highlightCanv.getContext("2d");
    this.highlightCtx.strokeStyle = this.browser.settings.highlightCellColor;
    this.highlightCtx.lineWidth = this.browser.settings.highlightCellLineWidth;
    this.highlightCanv.onmousemove = function(e) {
        var evt = e || event;
        HMHeat.highlightCell(evt.offsetX, evt.offsetY);
    };
    
    this.highlightCanv.onmouseout = function(e) {
        HMHeat.highlightCtx.clearRect(0, 0, HMHeat.highlightCanv.width, HMHeat.highlightCanv.height);
        HMHeat.browser.onMouseOut();
    };
};

HMHeatmap.prototype.setWidth = function(width) {
    this.width = width;
    this.canv.width = width;
    this.highlightCanv.width = width;
    this.searchHighlightCanv.width = width;
    this.highlightCtx.strokeStyle = this.browser.settings.highlightCellColor;
    this.highlightCtx.lineWidth = this.browser.settings.highlightCellLineWidth;
    this.searchHighlightCtx.fillStyle = this.browser.settings.highlightSearchFill;
    this.searchHighlightCtx.globalAlpha = this.browser.settings.highlightSearchStrokeOpacity;
};

HMHeatmap.prototype.setHeight = function(height) {
    this.height = height;
    this.canv.height = height;
    this.highlightCanv.height = height;
    this.searchHighlightCanv.height = height;
    this.highlightCtx.strokeStyle = this.browser.settings.highlightCellColor;
    this.highlightCtx.lineWidth = this.browser.settings.highlightCellLineWidth;
    this.searchHighlightCtx.fillStyle = this.browser.settings.highlightSearchFill;
    this.searchHighlightCtx.globalAlpha = this.browser.settings.highlightSearchStrokeOpacity;
};

HMHeatmap.prototype.highlightCell = function(x, y) {
    var cw = this.browser.settings.cellWidth * this.browser.zoom;
    var ch = this.browser.settings.cellHeight * this.browser.zoom;
    
    var j = Math.floor((x + this.scrollX)/cw);
    var i = Math.floor((y + this.scrollY)/ch);
    
    // Draw highlight box
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);
    this.highlightCtx.strokeRect((cw*j)-this.scrollX, (ch*i)-this.scrollY, cw, ch);
    
    // Tooltip
    var placementX = ((cw*j)-this.scrollX) + this.browser.hmTL.left + ch;
    var placementY = ((ch*i)-this.scrollY) + this.browser.hmTL.top + cw;
    this.browser.showTooltip(placementX, placementY);

    // Draw highlight lines
    // Vertical
    this.highlightCtx.beginPath();
    this.highlightCtx.moveTo((cw*j)-this.scrollX, 0);
    this.highlightCtx.lineTo((cw*j)-this.scrollX, this.height);
    this.highlightCtx.stroke();
    
    this.highlightCtx.beginPath();
    this.highlightCtx.moveTo((cw*(j+1))-this.scrollX, 0);
    this.highlightCtx.lineTo((cw*(j+1))-this.scrollX, this.height);
    this.highlightCtx.stroke();
    
    // Horizontal 
    this.highlightCtx.beginPath();
    this.highlightCtx.moveTo(0, (ch*i)-this.scrollY);
    this.highlightCtx.lineTo(this.width, (ch*i)-this.scrollY);
    this.highlightCtx.stroke();
    
    this.highlightCtx.beginPath();
    this.highlightCtx.moveTo(0, (ch*(i+1))-this.scrollY);
    this.highlightCtx.lineTo(this.width, (ch*(i+1))-this.scrollY);
    this.highlightCtx.stroke();
    
    // Notify browser
    this.browser.onHighlightCell(i, j);
};

HMHeatmap.prototype.indices2ranges = function(indices) {
    if (!indices) { return []; }
    
    var ranges = [];
    var startIdx = 0;
    var currVal = indices[0];
    for (var i = 1; i < indices.length; ++i) {
        currVal += 1;
        if (indices[i] !== currVal) {
            ranges.push({ start: indices[startIdx], end: indices[i-1] });
            startIdx = i;
            currVal = indices[i];
        }
    }
    
    ranges.push({ start: indices[startIdx], end: indices[indices.length-1] });
    
    return ranges;
};

HMHeatmap.prototype.searchHighlightCellRanges = function(indices) {
    var cw = this.browser.settings.cellWidth * this.browser.zoom;
    var ch = this.browser.settings.cellHeight * this.browser.zoom;
    
    this.highlightedSearchIndices = indices;
    
    this.searchHighlightCtx.clearRect(0, 0, this.searchHighlightCanv.width, this.searchHighlightCanv.height);
    
    var ranges = this.indices2ranges(indices);
    for (var i = 0; i < ranges.length; ++i) {
        var range = ranges[i];
        
        this.searchHighlightCtx.beginPath();
        this.searchHighlightCtx.moveTo(0, (ch*range.start)-this.scrollY);
        this.searchHighlightCtx.lineTo(this.width, (ch*range.start)-this.scrollY);
        this.searchHighlightCtx.stroke();
        
        this.searchHighlightCtx.beginPath();
        this.searchHighlightCtx.moveTo(0, (ch*(range.end+1))-this.scrollY);
        this.searchHighlightCtx.lineTo(this.width, (ch*(range.end+1))-this.scrollY);
        this.searchHighlightCtx.stroke();
    }
};

HMHeatmap.prototype.clear = function() {
    this.ctx.clearRect(0, 0, this.canv.width, this.canv.height);
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);
    this.searchHighlightCtx.clearRect(0, 0, this.searchHighlightCanv.width, this.searchHighlightCanv.height);
};

HMHeatmap.prototype.setScrollX = function(scrollX) {
    this.scrollX = scrollX;
};

HMHeatmap.prototype.setScrollY = function(scrollY) {
    this.scrollY = scrollY;
};

HMHeatmap.prototype.onScrollX = function(scrollX) {
    this.scrollX = scrollX;
    this.redraw();
};

HMHeatmap.prototype.onScrollY = function(scrollY) {
    this.scrollY = scrollY;
    this.redraw();
};

HMHeatmap.prototype.render = function() {
    var cw = this.browser.settings.cellWidth * this.browser.zoom;
    var ch = this.browser.settings.cellHeight * this.browser.zoom;
    for(var i = 0; i < this.numRows; ++i) {
        for(var j = 0; j < this.numCols; ++j) {
            if (this.browser.inVisibleArea(i, j)) {
                this.ctx.fillStyle= this.data[i][j];
                this.ctx.fillRect((cw*j)-this.scrollX, (ch*i)-this.scrollY, cw, ch);
            }
        }
    }
    this.ctx.stroke();
    this.searchHighlightCellRanges(this.highlightedSearchIndices);
};

HMHeatmap.prototype.redraw = function() {
    this.clear();
    this.render();
};

function HMColHeaders(hmBr, width, height, colHeaders) {
    this.browser = hmBr;
    this.height = height;
    this.width = width;
    this.colHeaders = colHeaders;
    this.scrollX = 0;
}

HMColHeaders.prototype.init = function() {
    var hmBr = this;
    this.colHeaderCanv = createCanvas('hmColHeadCanvas', this.width, 0, 'position: absolute; top: 0');
    this.highlightCanv = createCanvas('hmColHeadHighlightCanvas', this.width, 0, 'position: absolute; top: 0');
    this.browser.parentDiv.appendChild(this.colHeaderCanv);
    this.browser.parentDiv.appendChild(this.highlightCanv);
    this.colHeaderCtx = this.colHeaderCanv.getContext("2d");
    this.highlightCtx = this.highlightCanv.getContext("2d");
    this.height = this.getMaxWidth(this.colHeaders, this.colHeaderCtx);
    this.colHeaderCanv.height = this.height;
    this.highlightCanv.height = this.height;
    this.highlightCtx.strokeStyle = this.browser.settings.highlightCellColor;
    this.highlightCtx.lineWidth = this.browser.settings.highlightCellLineWidth;
};

HMColHeaders.prototype.getMaxWidth = function(textArr, ctx) {
    var w = 0;
    for(var i = 0; i < textArr.length; ++i) {
        w = Math.max(ctx.measureText(textArr[i]).width + (2*this.browser.settings.labelTextPadding), w);
    }
    return w;
};

HMColHeaders.prototype.render = function() {
    var cw = this.browser.settings.cellWidth * this.browser.zoom;
    // Somewhat hard to understand, but we have to esentially rotate the whole context/coord system
    // for every label we are rendering in order to get rotated text
    for(var i = 0; i < this.colHeaders.length; ++i) {
        this.colHeaderCtx.save();
        this.colHeaderCtx.translate(i*cw + (cw/2) + this.browser.hmTL.left - this.scrollX, this.height/2);
        this.colHeaderCtx.rotate(-Math.PI/4);
        this.colHeaderCtx.textAlign = 'center';
        this.colHeaderCtx.textBaseline = 'middle';
        this.colHeaderCtx.fillText(this.colHeaders[i], this.browser.settings.labelTextPadding/2, 0);
        this.colHeaderCtx.restore();
    }
};

HMColHeaders.prototype.setScrollX = function(scrollX) {
    this.scrollX = scrollX;
};

HMColHeaders.prototype.clear = function() {
    this.colHeaderCtx.clearRect(0, 0, this.colHeaderCanv.width, this.colHeaderCanv.height);
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);
};

HMColHeaders.prototype.clearHighlights = function() {
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);
};

HMColHeaders.prototype.redraw = function() {
    this.clear();
    this.render();
};

HMColHeaders.prototype.highlightHeader = function(i, j) {    
    var cw = this.browser.settings.cellWidth * this.browser.zoom;
    var ch = this.browser.settings.cellHeight * this.browser.zoom;
    
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);

    // Draw highlight lines
    // Vertical
    this.highlightCtx.beginPath();
    this.highlightCtx.moveTo((cw*j) + this.browser.hmTL.left - this.scrollX, 0);
    this.highlightCtx.lineTo((cw*j) + this.browser.hmTL.left - this.scrollX, this.height);
    this.highlightCtx.stroke();
    
    this.highlightCtx.beginPath();
    this.highlightCtx.moveTo((cw*(j+1)) + this.browser.hmTL.left - this.scrollX, 0);
    this.highlightCtx.lineTo((cw*(j+1)) + this.browser.hmTL.left - this.scrollX, this.height);
    this.highlightCtx.stroke();
};

HMColHeaders.prototype.setWidth = function(width) {
    this.width = width;
    this.colHeaderCanv.width = width;
    this.highlightCanv.width = width;
    this.highlightCtx.strokeStyle = this.browser.settings.highlightCellColor;
    this.highlightCtx.lineWidth = this.browser.settings.highlightCellLineWidth;
};

HMColHeaders.prototype.onScrollX = function(scrollX) {
    this.scrollX = scrollX;
    this.redraw();
};

HMColHeaders.prototype.onScrollY = function(scrollY) {
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);
};

HMColHeaders.prototype.onHighlightCell = function(i, j) {
    this.highlightHeader(i,j);
};

function HMRowHeaders(hmBr, width, height, rowHeaders) {
    this.browser = hmBr;
    this.width = width;
    this.height = height;
    this.rowHeaders = rowHeaders;
    this.scrollY = 0;
    this.highlightedSearchIndices = [];
    this.headerWidths = [];
    this.approxHeaderHeights = this.browser.settings.rowFontSizePt * 1.5;
}

HMRowHeaders.prototype.init = function() {
    var hmBr = this;
    this.rowHeaderCanv = createCanvas('hmRowHeadCanvas', 0, this.height, 'position: absolute; left: 0');
    this.highlightCanv = createCanvas('hmRowHeadHighlightCanvas', 0, this.height, 'position: absolute; left: 0');
    this.searchHighlightCanv = createCanvas('hmRowHeadSearchHighlightCanvas', 0, this.height, 'position: absolute; left: 0');
    this.browser.parentDiv.appendChild(this.rowHeaderCanv);
    this.browser.parentDiv.appendChild(this.highlightCanv);
    this.browser.parentDiv.appendChild(this.searchHighlightCanv);
    this.rowHeaderCtx = this.rowHeaderCanv.getContext("2d");
    this.rowHeaderCtx.font = this.browser.settings.rowFontSizePt + 'pt ' + this.browser.settings.rowFontFamily;
    this.highlightCtx = this.highlightCanv.getContext("2d");
    this.searchHighlightCtx = this.searchHighlightCanv.getContext("2d");
    this.width = this.getMaxWidth(this.rowHeaders, this.rowHeaderCtx);
    this.rowHeaderCanv.width = this.width;
    this.highlightCanv.width = this.width;
    this.searchHighlightCanv.width = this.width;
    this.rowHeaderCtx.font = this.browser.settings.rowFontSizePt + 'pt ' + this.browser.settings.rowFontFamily;
    this.highlightCtx.strokeStyle = this.browser.settings.highlightCellColor;
    this.highlightCtx.lineWidth = this.browser.settings.highlightCellLineWidth;
    this.searchHighlightCtx.fillStyle = this.browser.settings.highlightSearchFill;
    this.searchHighlightCtx.globalAlpha = this.browser.settings.highlightSearchOpacity;
};

HMRowHeaders.prototype.getMaxWidth = function(textMat, ctx) {
    var w = 0;
    for(var i = 0; i < textMat.length; ++i) {
        var colWidths = 0;
        if (textMat[i].length) {
            this.headerWidths[i] = [];
            for(var j = 0; j < textMat[i].length; ++j) {
                var curr = ctx.measureText(textMat[i][j]).width + (2*this.browser.settings.labelTextPadding);
                this.headerWidths[i].push(curr);
                colWidths += curr;
            }
        } else {
            colWidths = ctx.measureText(textMat[i]).width + (2*this.browser.settings.labelTextPadding);
        }
        w = Math.max(colWidths, w);
    }
    return w;
};

HMRowHeaders.prototype.render = function() {
    var ch = this.browser.settings.cellHeight * this.browser.zoom;
    
    if (this.approxHeaderHeights <= ch) {
        this.rowHeaderCtx.textBaseline = 'middle';
        for(var i = 0; i < this.rowHeaders.length; ++i) {
            if (this.rowHeaders[i].length) {
                var currWidth = 0;
                // Render the first col then loop through any remaining
                this.rowHeaderCtx.fillText(this.rowHeaders[i][0], this.browser.settings.labelTextPadding, i*ch + (ch/2) + this.browser.hmTL.top - this.scrollY);
                for(var j = 1; j < this.rowHeaders[i].length; ++j) {
                    currWidth += this.headerWidths[i][j-1];
                    this.rowHeaderCtx.fillText(this.rowHeaders[i][j], (currWidth) + this.browser.settings.labelTextPadding, i*ch + (ch/2) + this.browser.hmTL.top - this.scrollY);
                }
            } else {
                this.rowHeaderCtx.fillText(this.rowHeaders[i], this.browser.settings.labelTextPadding, i*ch + (ch/2) + this.browser.hmTL.top - this.scrollY);
            }
        }
    }
    this.searchHighlightHeaders(this.highlightedSearchIndices);
};

HMRowHeaders.prototype.highlightHeader = function(i, j) {    
    var cw = this.browser.settings.cellWidth * this.browser.zoom;
    var ch = this.browser.settings.cellHeight * this.browser.zoom;
    
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);

    // Horizontal 
    this.highlightCtx.beginPath();
    this.highlightCtx.moveTo(0, (ch*i) + this.browser.hmTL.top - this.scrollY);
    this.highlightCtx.lineTo(this.width, (ch*i) + this.browser.hmTL.top - this.scrollY);
    this.highlightCtx.stroke();
    
    this.highlightCtx.beginPath();
    this.highlightCtx.moveTo(0, (ch*(i+1)) + this.browser.hmTL.top - this.scrollY);
    this.highlightCtx.lineTo(this.width, (ch*(i+1)) + this.browser.hmTL.top - this.scrollY);
    this.highlightCtx.stroke();
};

HMRowHeaders.prototype.search = function(query) {
    if (!query) { return []; }
    
    query = query.toLowerCase();
    var indices = [];
    for (var i = 0; i < this.rowHeaders.length; ++i) {
        if (this.rowHeaders[i].length) {
            for(var j = 0; j < this.rowHeaders[i].length; ++j) {
                if (this.rowHeaders[i][j].toLowerCase().indexOf(query) > -1) {
                  indices.push(i);
                  break;
                }
            }
        } else {
            if (this.rowHeaders[i].toLowerCase().indexOf(query) > -1) {
              indices.push(i);
            }
        }
    }
    return indices;
};

HMRowHeaders.prototype.searchHighlightHeaders = function(indices) {
    var cw = this.browser.settings.cellWidth * this.browser.zoom;
    var ch = this.browser.settings.cellHeight * this.browser.zoom;
    
    this.highlightedSearchIndices = indices;
    
    this.searchHighlightCtx.clearRect(0, 0, this.searchHighlightCanv.width, this.searchHighlightCanv.height);
    
    for (var i = 0; i < indices.length; ++i) {
        var idx = indices[i];
        this.searchHighlightCtx.fillRect(0, (ch*idx) + this.browser.hmTL.top - this.scrollY, this.width, ch);
    }
};

HMRowHeaders.prototype.setScrollY = function(scrollY) {
    this.scrollY = scrollY;
};

HMRowHeaders.prototype.clear = function() {
    this.rowHeaderCtx.clearRect(0, 0, this.rowHeaderCanv.width, this.rowHeaderCanv.height);
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);
    this.searchHighlightCtx.clearRect(0, 0, this.searchHighlightCanv.width, this.searchHighlightCanv.height);
};

HMRowHeaders.prototype.clearHighlights = function() {
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);
};

HMRowHeaders.prototype.redraw = function() {
    this.clear();
    this.render();
};

HMRowHeaders.prototype.setHeight = function(height) {
    this.height = height;
    this.rowHeaderCanv.height = height;
    this.highlightCanv.height = height;
    this.searchHighlightCanv.height = height;
    this.rowHeaderCtx.font = this.browser.settings.rowFontSizePt + 'pt ' + this.browser.settings.rowFontFamily;
    this.highlightCtx.strokeStyle = this.browser.settings.highlightCellColor;
    this.highlightCtx.lineWidth = this.browser.settings.highlightCellLineWidth;
    this.searchHighlightCtx.fillStyle = this.browser.settings.highlightSearchFill;
    this.searchHighlightCtx.globalAlpha = this.browser.settings.highlightSearchOpacity;
};

HMRowHeaders.prototype.onScrollX = function(scrollX) {
    this.highlightCtx.clearRect(0, 0, this.highlightCanv.width, this.highlightCanv.height);
};

HMRowHeaders.prototype.onScrollY = function(scrollY) {
    this.scrollY = scrollY;
    this.redraw();
};

HMRowHeaders.prototype.onHighlightCell = function(i, j) {
    this.highlightHeader(i,j);
};

function HMBrowser(parentDiv, tooltipDiv, rowHeaders, colHeaders, data, settings) {
    this.parentDiv = parentDiv;
    this.tooltipDiv = tooltipDiv;
    this.maxWidth = parentDiv.clientWidth;
    this.width = this.maxWidth;
    this.maxHeight = parentDiv.clientHeight;
    this.height = this.maxHeight;
    this.rowHeaders = rowHeaders;
    this.numRows = rowHeaders.length;
    this.colHeaders = colHeaders;
    this.numCols = colHeaders.length;
    this.data = data;
    this.zoom = 1.0;
    this.scrollX = 0;
    this.scrollY = 0;
    this.scrollingX = false;
    this.scrollingY = false;
    this.needsHorizScroll = false;
    this.needsVertScroll = false;
    this.settings = settings || { labelTextPadding: 2,
                                  cellWidth: 20, 
                                  cellHeight: 20, 
                                  vertScrollWidth: 10, 
                                  horizScrollHeight: 10,
                                  rowFontSizePt: 8,
                                  rowFontFamily: 'sans-serif',
                                  colFontSizePt: 8,
                                  colFontFamily: 'sans-serif',
                                  defaultScrollerFill: '#CCC', 
                                  highlightSearchStroke: '#333',
                                  highlightSearchStrokeOpacity: 1.0,
                                  highlightSearchFill: '#33CCFF',
                                  highlightSearchOpacity: 0.3,
                                  highlightScrollerFill: '#999', 
                                  highlightCellColor: '#CC0000', 
                                  highlightCellLineWidth: 1 };
}

HMBrowser.prototype.init = function() {
    var hmBr = this;

    this.colHeads = new HMColHeaders(this, this.width, this.settings.cellHeight, this.colHeaders);
    this.rowHeads = new HMRowHeaders(this, this.settings.cellWidth, this.height, this.rowHeaders);
    
    // Must init here in order to get the correct sizes for the text in the headers
    this.colHeads.init();
    this.rowHeads.init();
    
    this.hmTL = { top: this.colHeads.height, left: this.rowHeads.width };
    
    this.width = (this.numCols * this.settings.cellWidth * this.zoom) + this.hmTL.left;
    if (this.width > this.maxWidth) {
        this.needsHorizScroll = true;
        this.width = this.maxWidth;
    }
    
    this.height = (this.numRows * this.settings.cellHeight * this.zoom) + this.hmTL.top;
    if (this.height > this.maxHeight) {
        this.needsVertScroll = true;
        this.height = this.maxHeight;
    }
    
    if (!this.needsHorizScroll) {
        this.width = this.width + (this.needsVertScroll ? this.settings.vertScrollWidth : 0);
    }
    
    if (!this.needsVertScroll) {
        this.height = this.height + (this.needsHorizScroll ? this.settings.horizScrollHeight : 0);
    }
    
    var vertScrollWidth = this.needsVertScroll ? this.settings.vertScrollWidth : 0;
    var vertScrollHeight = this.needsHorizScroll ? (this.height - this.colHeads.height - this.settings.horizScrollHeight) : this.height - this.colHeads.height;
    this.vertScroll = new HMVertScrollBar(this, vertScrollWidth, vertScrollHeight);
    
    var horizScrollHeight = this.needsHorizScroll ? this.settings.horizScrollHeight : 0;
    var horizScrollWidth = this.needsVertScroll ? (this.width - this.rowHeads.width - this.settings.vertScrollWidth) : this.width - this.rowHeads.width;
    this.horizScroll = new HMHorizScrollBar(this, horizScrollWidth, horizScrollHeight);
    
    this.colHeads.setWidth(this.width - vertScrollWidth);
    this.rowHeads.setHeight(this.height - horizScrollHeight);
    
    var textOvrCanv = createCanvas('hmTextOverflowCover1', this.hmTL.left, this.hmTL.top, 'position: absolute; top: 0; left: 0;');
    this.parentDiv.appendChild(textOvrCanv);
    var textOvrCanv = createCanvas('hmTextOverflowCover2', this.hmTL.left, this.horizScroll.height, 'position: absolute; top: ' + (this.height - horizScrollHeight) + 'px; left: 0;');
    this.parentDiv.appendChild(textOvrCanv);
    var textOvrCanv = createCanvas('hmTextOverflowCover3', this.vertScroll.width, this.hmTL.top, 'position: absolute; top: 0; left: ' + (this.width - vertScrollWidth) + 'px;');
    this.parentDiv.appendChild(textOvrCanv);
    
    this.heatmap = new HMHeatmap(this, this.width - this.rowHeads.width - this.vertScroll.width, this.height - this.colHeads.height - this.horizScroll.height, this.data, this.numRows, this.numCols, this.hmTL);

    // Init the other components
    this.heatmap.init();
    this.vertScroll.init();
    this.horizScroll.init();

    window.onmousemove = function(e) {
        var evt = e || event;
        hmBr.vertScroll.onMouseMove(evt);
        hmBr.horizScroll.onMouseMove(evt);
    };
    window.onmouseup = function(e) {
        var evt = e || event;
        hmBr.vertScroll.onMouseUp(evt);
        hmBr.horizScroll.onMouseUp(evt);
    };
    this.parentDiv.onwheel = function(e) {
        var evt = e || event;
        
        hmBr.hideTooltip();
        if (evt.shiftKey) {
            hmBr.horizScroll.onWheel(evt);
        } else {
            hmBr.vertScroll.onWheel(evt);
        }
    };
};

HMBrowser.prototype.getHeatmapHeight = function() {
    var extra = this.needsHorizScroll ? this.settings.horizScrollHeight : 0;
    return this.maxHeight - this.hmTL.top - extra;
};

HMBrowser.prototype.getHeatmapWidth = function() {
    var extra = this.needsVertScroll ? this.settings.vertScrollWidth : 0;
    return this.maxWidth - this.hmTL.left - extra;
};

HMBrowser.prototype.showTooltip = function (placementX, placementY) {
    var cw = this.settings.cellWidth * this.zoom;
    var ch = this.settings.cellHeight * this.zoom;
    if (placementX + this.tooltipDiv.offsetWidth > this.maxWidth) {
        this.tooltipDiv.style.top = placementY - this.tooltipDiv.offsetHeight - ch + 'px';
        this.tooltipDiv.style.left = placementX - this.tooltipDiv.offsetWidth - cw + 'px';
    } else {
        this.tooltipDiv.style.top = placementY + 'px';
        this.tooltipDiv.style.left = placementX + 'px';
    }
    this.tooltipDiv.style.display = 'block';
}

HMBrowser.prototype.hideTooltip = function () {
    this.tooltipDiv.style.display = 'none';
}

HMBrowser.prototype.onZoom = function() {
    this.scrollX = this.scrollY = 0;
    this.needsVertScroll = this.needsHorizScroll = false;
    
    this.vertScroll.setScrollY(0);
    this.horizScroll.setScrollX(0);
    this.colHeads.setScrollX(0);
    this.rowHeads.setScrollY(0);
    this.heatmap.setScrollX(0);
    this.heatmap.setScrollY(0);
    
    this.width = (this.numCols * this.settings.cellWidth * this.zoom) + this.hmTL.left;
    if (this.width > this.maxWidth) {
        this.needsHorizScroll = true;
        this.width = this.maxWidth;
    }
    
    this.height = (this.numRows * this.settings.cellHeight * this.zoom) + this.hmTL.top;
    if (this.height > this.maxHeight) {
        this.needsVertScroll = true;
        this.height = this.maxHeight;
    }
    
    if (!this.needsHorizScroll) {
        this.width = this.width + (this.needsVertScroll ? this.settings.vertScrollWidth : 0);
    }
    
    if (!this.needsVertScroll) {
        this.height = this.height + (this.needsHorizScroll ? this.settings.horizScrollHeight : 0);
    }
    
    var vertScrollWidth = this.needsVertScroll ? this.settings.vertScrollWidth : 0;
    var vertScrollHeight = this.needsHorizScroll ? (this.height - this.colHeads.height - this.settings.horizScrollHeight) : this.height - this.colHeads.height;
    this.vertScroll.setWidth(vertScrollWidth);
    this.vertScroll.setHeight(vertScrollHeight);
    
    var horizScrollHeight = this.needsHorizScroll ? this.settings.horizScrollHeight : 0;
    var horizScrollWidth = this.needsVertScroll ? (this.width - this.rowHeads.width - this.settings.vertScrollWidth) : this.width - this.rowHeads.width;
    this.horizScroll.setWidth(horizScrollWidth);
    this.horizScroll.setHeight(horizScrollHeight);
    
    this.colHeads.setWidth(this.width - vertScrollWidth);
    this.rowHeads.setHeight(this.height - horizScrollHeight);
    
    var cover2 = document.getElementById('hmTextOverflowCover2');
    cover2.height = horizScrollHeight;
    cover2.style.top = (this.height - horizScrollHeight);
    var cover3 = document.getElementById('hmTextOverflowCover3');
    cover3.width = vertScrollWidth;
    cover3.style.top = (this.width - vertScrollWidth);
    
    this.heatmap.setWidth(this.width - this.rowHeads.width - this.vertScroll.width);
    this.heatmap.setHeight(this.height - this.colHeads.height - this.horizScroll.height);
};

HMBrowser.prototype.zoomIn = function() {
    this.zoom += 0.02;
    this.onZoom();
    this.redraw();
};

HMBrowser.prototype.zoomOut = function() {
    this.zoom -= 0.02;
    this.onZoom();
    this.redraw();
};

HMBrowser.prototype.zoomExact = function(zoom) {
    this.zoom = zoom;
    this.onZoom();
    this.redraw();
};

HMBrowser.prototype.searchRows = function(query) {
    var indices = this.rowHeads.search(query);
    this.rowHeads.searchHighlightHeaders(indices);
    this.heatmap.searchHighlightCellRanges(indices);
};

HMBrowser.prototype.onMouseOut = function() {
    this.hideTooltip();
    this.colHeads.clearHighlights();
    this.rowHeads.clearHighlights();
};

HMBrowser.prototype.onScrollY = function(scrollY) {
    // Convert to scroll in terms of heatmap
    var wholeMapHeight = this.settings.cellHeight * this.zoom * this.numRows;
    var convRatio = wholeMapHeight/this.vertScroll.height;
    scrollY = scrollY * convRatio;
    
    // Update components
    this.scrollY = scrollY;
    this.heatmap.onScrollY(scrollY);
    this.colHeads.onScrollY(scrollY);
    this.rowHeads.onScrollY(scrollY);
};

HMBrowser.prototype.onScrollX = function(scrollX) {
    // Convert to scroll in terms of heatmap
    var wholeMapWidth = this.settings.cellWidth * this.zoom * this.numCols;
    var convRatio = wholeMapWidth/this.horizScroll.width;
    scrollX = scrollX * convRatio;

    // Update components
    this.scrollX = scrollX;
    this.heatmap.onScrollX(scrollX);
    this.colHeads.onScrollX(scrollX);
    this.rowHeads.onScrollX(scrollX);
};

HMBrowser.prototype.onHighlightCell = function(i, j) {
    this.colHeads.onHighlightCell(i,j);
    this.rowHeads.onHighlightCell(i,j);
};

HMBrowser.prototype.inVisibleArea = function(i, j) {
    var cw = this.settings.cellWidth * this.zoom;
    var ch = this.settings.cellHeight * this.zoom;
    var box = { top: i * ch, left: j * cw, right: j * cw + cw, bottom: i * ch + ch };
    var boxWin = { top: this.scrollY, left: this.scrollX, right: this.scrollX + this.width, bottom: this.scrollY + this.height };
    return  !(box.right < boxWin.left || box.left > boxWin.right || box.bottom < boxWin.top || box.top > boxWin.bottom);
}

HMBrowser.prototype.redraw = function() {
    this.colHeads.redraw();
    this.rowHeads.redraw();
    this.heatmap.redraw();
    this.vertScroll.redraw();
    this.horizScroll.redraw();
};

HMBrowser.prototype.render = function() {
    this.colHeads.render();
    this.rowHeads.render();
    this.heatmap.render();
    this.vertScroll.render();
    this.horizScroll.render();
};

function pad(n, width, z) {
    z = z || '0';
    n = n + '';
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}

var numrows = 4000;
var numcols = 300;

var rowHeads = [];
for(var i = 0; i < numrows; ++i) {
    var cols = [];
    cols.push('Rv' + pad(i, 4));
    cols.push(''+i);
    cols.push('a'+(i%26));
    rowHeads.push(cols); 
}
//for(var i = 0; i < 4000; ++i) { rowHeads.push(i); }

var colHeads = [];
for(var i = 0; i < numcols; ++i) { colHeads.push(i); }

var data = [];
for(var i = 0; i < numrows; ++i) {
    row = [];
    for(var j = 0; j < numcols; ++j) {
        var rand = (Math.random() * 2) - 1;
        if (rand < 0) {
            row.push('rgb(' + Math.floor((1+rand)*255) + ',' + Math.floor((1+rand)*255) + ', 255)');
        } else {
            row.push('rgb(255,255,' + Math.floor((1 - rand)*255) + ')');
        }
    }
    data.push(row);
}

document.onselectstart = function(){ return false; }

var br = new HMBrowser(document.getElementById('testCanv'), document.getElementById('canvToolTip'), rowHeads, colHeads, data);
br.init();
br.render();

</script>

</body>
</html>

